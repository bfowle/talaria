<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Manifest Format - Talaria Documentation</title>


        <!-- Custom HTML head -->
        <!-- MathJax Configuration -->
        <script>
        window.MathJax = {
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true
          },
          TeX: {
            equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"]
          }
        };
        </script>
        <meta name="description" content="Intelligent FASTA reduction for aligner index optimization">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "ayu";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Talaria Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Andromeda-Tech/talaria" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Andromeda-Tech/talaria/edit/main/docs/src/casg/manifest.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="manifest-format-specification-the-database-genome"><a class="header" href="#manifest-format-specification-the-database-genome">Manifest Format Specification: The Database Genome</a></h1>
<h2 id="overview-small-files-massive-impact"><a class="header" href="#overview-small-files-massive-impact">Overview: Small Files, Massive Impact</a></h2>
<p>The manifest is the heart of the CASG system—a small, efficiently-structured JSON file that completely describes the state of a multi-gigabyte sequence database. Think of it as the “genome” of your database: just as DNA encodes an entire organism in a tiny molecule, the manifest encodes an entire database in typically 50-500KB.</p>
<h3 id="why-manifests-matter"><a class="header" href="#why-manifests-matter">Why Manifests Matter</a></h3>
<p>Consider the traditional approach to checking for database updates: you either trust that your local copy is current (dangerous for reproducibility) or you re-download the entire database to be sure (wasteful). The manifest solves this elegantly:</p>
<ol>
<li><strong>Instant Update Checks</strong>: A simple HTTP HEAD request (1KB) tells you if updates exist</li>
<li><strong>Precise Diffs</strong>: The manifest lists every chunk, so you know exactly what changed</li>
<li><strong>Cryptographic Proof</strong>: Merkle roots prove the database hasn’t been tampered with</li>
<li><strong>Perfect Reproducibility</strong>: A manifest hash uniquely identifies a database state forever</li>
</ol>
<h3 id="the-power-of-indirection"><a class="header" href="#the-power-of-indirection">The Power of Indirection</a></h3>
<p>Instead of moving massive databases around, we move tiny manifests. A researcher can email a colleague a 100KB manifest that precisely describes a 100GB database. The colleague downloads only the chunks they need, verified against the manifest’s cryptographic proofs. This indirection transforms database distribution from a bandwidth problem to a metadata problem.</p>
<h2 id="format-structure-anatomy-of-a-manifest"><a class="header" href="#format-structure-anatomy-of-a-manifest">Format Structure: Anatomy of a Manifest</a></h2>
<p>The manifest uses JSON for human readability and tooling compatibility, with a carefully designed schema that balances completeness with compactness.</p>
<h3 id="core-design-principles"><a class="header" href="#core-design-principles">Core Design Principles</a></h3>
<ol>
<li><strong>Self-Contained</strong>: Everything needed to reconstruct the database is in the manifest</li>
<li><strong>Verifiable</strong>: Multiple cross-checks ensure integrity</li>
<li><strong>Efficient</strong>: Optimized for rapid parsing and diff computation</li>
<li><strong>Extensible</strong>: Forward-compatible with future enhancements</li>
</ol>
<h3 id="json-schema"><a class="header" href="#json-schema">JSON Schema</a></h3>
<pre><code class="language-json">{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["version", "created_at", "taxonomy_root", "sequence_root", "chunk_index", "etag"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d{8}_\\d{6}$",
      "description": "Version identifier (YYYYMMDD_HHMMSS)"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    "taxonomy_root": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA256 hash of taxonomy Merkle tree root"
    },
    "sequence_root": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA256 hash of sequence Merkle tree root"
    },
    "chunk_index": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/ChunkMetadata"
      }
    },
    "discrepancies": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/TaxonomicDiscrepancy"
      }
    },
    "etag": {
      "type": "string",
      "description": "HTTP ETag for efficient update checking"
    },
    "previous_version": {
      "type": "string",
      "description": "Previous manifest version for chaining"
    }
  }
}
</code></pre>
<h3 id="example-manifest"><a class="header" href="#example-manifest">Example Manifest</a></h3>
<pre><code class="language-json">{
  "version": "20240315_143022",
  "created_at": "2024-03-15T14:30:22.000Z",
  "taxonomy_root": "abc123def456789012345678901234567890123456789012345678901234567",
  "sequence_root": "fedcba098765432109876543210987654321098765432109876543210987654",
  "chunk_index": [
    {
      "hash": "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcd",
      "taxon_ids": [562, 563, 564],
      "sequence_count": 15234,
      "size": 52428800,
      "compressed_size": 18350080
    },
    {
      "hash": "abcdef1234567890abcdef1234567890abcdef1234567890abcdef12345678",
      "taxon_ids": [9606],
      "sequence_count": 42150,
      "size": 157286400,
      "compressed_size": 48234496
    }
  ],
  "discrepancies": [
    {
      "sequence_id": "NP_123456.1",
      "header_taxon": 562,
      "mapped_taxon": 563,
      "confidence": 0.85,
      "discrepancy_type": "Conflict"
    }
  ],
  "etag": "W/\"5e3b-1710513022000\"",
  "previous_version": "20240215_120000"
}
</code></pre>
<h2 id="chunk-metadata-the-building-blocks"><a class="header" href="#chunk-metadata-the-building-blocks">Chunk Metadata: The Building Blocks</a></h2>
<p>Each chunk entry in the manifest provides complete information about that chunk without requiring access to the chunk itself. This enables intelligent decisions about which chunks to download.</p>
<h3 id="understanding-chunk-metadata"><a class="header" href="#understanding-chunk-metadata">Understanding Chunk Metadata</a></h3>
<p>Each chunk in the index contains:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Example</th></tr></thead><tbody>
<tr><td><code>hash</code></td><td>SHA256</td><td>Content hash of chunk</td><td><code>abc123...</code></td></tr>
<tr><td><code>taxon_ids</code></td><td>Array<TaxonId></td><td>Taxonomic IDs in chunk</td><td><code>[562, 563]</code></td></tr>
<tr><td><code>sequence_count</code></td><td>usize</td><td>Number of sequences</td><td><code>15234</code></td></tr>
<tr><td><code>size</code></td><td>usize</td><td>Uncompressed size in bytes</td><td><code>52428800</code></td></tr>
<tr><td><code>compressed_size</code></td><td>Optional<usize></td><td>Compressed size if applicable</td><td><code>18350080</code></td></tr>
</tbody></table>
</div>
<p>Note: ChunkMetadata does not contain a <code>taxonomy_version</code> field. Taxonomy version is tracked at the manifest level.</p>
<h2 id="etag-based-update-checking-efficiency-through-http"><a class="header" href="#etag-based-update-checking-efficiency-through-http">ETag-Based Update Checking: Efficiency Through HTTP</a></h2>
<p>ETags (Entity Tags) are an HTTP mechanism originally designed for web caching, but CASG repurposes them brilliantly for database update detection. Instead of downloading megabytes to check for changes, we send a tiny HTTP header and get a definitive answer.</p>
<h3 id="the-etag-advantage"><a class="header" href="#the-etag-advantage">The ETag Advantage</a></h3>
<p>Traditional database update checking:</p>
<ol>
<li>Download the database (or at least its index)</li>
<li>Compare with local version</li>
<li>Realize nothing changed</li>
<li>Waste: 100GB downloaded for nothing</li>
</ol>
<p>CASG with ETags:</p>
<ol>
<li>Send HTTP HEAD with cached ETag (1KB)</li>
<li>Receive 304 Not Modified (instant)</li>
<li>Done</li>
<li>Savings: 99.999% bandwidth reduction</li>
</ol>
<h3 id="how-it-works"><a class="header" href="#how-it-works">How It Works</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Client
    participant Server

    Client-&gt;&gt;Client: Load cached manifest &amp; ETag
    Client-&gt;&gt;Server: HEAD /manifest.json&lt;br/&gt;If-None-Match: &quot;5e3b-old&quot;

    alt No Updates
        Server--&gt;&gt;Client: 304 Not Modified
        Client-&gt;&gt;Client: Use cached manifest
    else Updates Available
        Server--&gt;&gt;Client: 200 OK&lt;br/&gt;ETag: &quot;5e3b-new&quot;
        Client-&gt;&gt;Server: GET /manifest.json
        Server--&gt;&gt;Client: New manifest
        Client-&gt;&gt;Client: Compare &amp; download changed chunks
    end
</pre>
<h3 id="implementation"><a class="header" href="#implementation">Implementation</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Check for updates
async fn check_updates(cached_etag: Option&lt;&amp;str&gt;) -&gt; Result&lt;bool&gt; {
    let client = reqwest::Client::new();
    let mut request = client.head(MANIFEST_URL);

    if let Some(etag) = cached_etag {
        request = request.header(IF_NONE_MATCH, etag);
    }

    let response = request.send().await?;

    // 304 = No updates
    Ok(response.status() != StatusCode::NOT_MODIFIED)
}
<span class="boring">}</span></code></pre></pre>
<h2 id="manifest-diffing-surgical-precision-updates"><a class="header" href="#manifest-diffing-surgical-precision-updates">Manifest Diffing: Surgical Precision Updates</a></h2>
<p>Manifest diffing is where CASG’s efficiency becomes apparent. By comparing two manifests, we can determine exactly which chunks changed, enabling surgical updates that download only what’s new.</p>
<h3 id="the-diff-process"><a class="header" href="#the-diff-process">The Diff Process</a></h3>
<p>Think of manifest diffing like comparing two shopping lists. Instead of buying everything again, you only buy what’s new or different. But unlike shopping lists, manifest diffs are computed in milliseconds and are cryptographically verifiable.</p>
<h3 id="algorithm"><a class="header" href="#algorithm">Algorithm</a></h3>
<p>When a new manifest is downloaded, compute the differential:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn diff_manifests(old: &amp;Manifest, new: &amp;Manifest) -&gt; ManifestDiff {
    let old_chunks: HashSet&lt;_&gt; = old.chunk_index
        .iter()
        .map(|c| c.hash.clone())
        .collect();

    let new_chunks: HashSet&lt;_&gt; = new.chunk_index
        .iter()
        .map(|c| c.hash.clone())
        .collect();

    ManifestDiff {
        added: new_chunks.difference(&amp;old_chunks).cloned().collect(),
        removed: old_chunks.difference(&amp;new_chunks).cloned().collect(),
        taxonomy_changed: old.taxonomy_root != new.taxonomy_root,
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="visualization"><a class="header" href="#visualization">Visualization</a></h3>
<pre class="mermaid">graph LR
    subgraph &quot;Old Manifest&quot;
        O1[Chunk A]
        O2[Chunk B]
        O3[Chunk C]
    end

    subgraph &quot;New Manifest&quot;
        N1[Chunk A]
        N2[Chunk B]
        N4[Chunk D]
        N5[Chunk E]
    end

    subgraph &quot;Diff Result&quot;
        D1[Keep: A, B]
        D2[Remove: C]
        D3[Add: D, E]
    end

    O1 -.-&gt; N1
    O2 -.-&gt; N2
    O3 --&gt; D2
    N4 --&gt; D3
    N5 --&gt; D3

    style O1 stroke:#757575,stroke-width:2px
    style O2 stroke:#757575,stroke-width:2px
    style O3 stroke:#d32f2f,stroke-width:2px
    style N1 stroke:#757575,stroke-width:2px
    style N2 stroke:#757575,stroke-width:2px
    style N4 stroke:#388e3c,stroke-width:2px
    style N5 stroke:#388e3c,stroke-width:2px
    style D1 stroke:#1976d2,stroke-width:2px
    style D2 stroke:#d32f2f,stroke-width:2px
    style D3 stroke:#388e3c,stroke-width:2px
</pre>
<h2 id="discrepancy-tracking-data-quality-assurance"><a class="header" href="#discrepancy-tracking-data-quality-assurance">Discrepancy Tracking: Data Quality Assurance</a></h2>
<p>One of CASG’s unique features is active discrepancy detection and tracking. Biological databases often contain inconsistencies—sequences claimed to be from one organism but actually from another, outdated taxonomic classifications, or missing annotations. The manifest doesn’t hide these issues; it documents them.</p>
<h3 id="why-track-discrepancies"><a class="header" href="#why-track-discrepancies">Why Track Discrepancies?</a></h3>
<ol>
<li><strong>Scientific Integrity</strong>: Researchers need to know about potential data quality issues</li>
<li><strong>Reproducibility</strong>: Papers can reference specific discrepancies they handled</li>
<li><strong>Continuous Improvement</strong>: Database maintainers can prioritize fixes</li>
<li><strong>Audit Trail</strong>: Track how classifications change over time</li>
</ol>
<h3 id="discrepancy-format"><a class="header" href="#discrepancy-format">Discrepancy Format</a></h3>
<p>The manifest includes detected discrepancies:</p>
<pre><code class="language-json">{
  "discrepancies": [
    {
      "sequence_id": "NP_123456.1",
      "header_taxon": 562,      // E. coli claimed
      "mapped_taxon": 563,       // Shigella in accession2taxid
      "inferred_taxon": 562,     // E. coli by similarity
      "confidence": 0.92,
      "detection_date": "2024-03-15T14:30:22Z",
      "discrepancy_type": "Conflict"
    },
    {
      "sequence_id": "XP_789012.2",
      "header_taxon": null,      // No taxonomy in header
      "mapped_taxon": 1578,      // Old Lactobacillus
      "inferred_taxon": 134567,  // New classification
      "confidence": 0.78,
      "detection_date": "2024-03-15T14:30:22Z",
      "discrepancy_type": "Reclassified"
    }
  ]
}
</code></pre>
<h2 id="bandwidth-optimization-the-economics-of-updates"><a class="header" href="#bandwidth-optimization-the-economics-of-updates">Bandwidth Optimization: The Economics of Updates</a></h2>
<p>Bandwidth costs money and time. For researchers in bandwidth-constrained environments or institutions with metered connections, CASG’s optimizations can mean the difference between feasible and impossible.</p>
<h3 id="real-world-impact"><a class="header" href="#real-world-impact">Real-World Impact</a></h3>
<p>Consider a lab checking for UniProt updates daily:</p>
<ul>
<li><strong>Traditional</strong>: 365 × 100GB = 36.5TB/year (mostly redundant)</li>
<li><strong>CASG</strong>: 365 × 1KB checks + 12 × 2GB updates = 24GB/year</li>
<li><strong>Savings</strong>: 99.93% bandwidth reduction</li>
</ul>
<p>For cloud users paying for egress:</p>
<ul>
<li><strong>Traditional</strong>: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">285/</span><span class="mord mathnormal">ye</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span></span></span></span>0.09/GB)</li>
<li><strong>CASG</strong>: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2.16/</span><span class="mord mathnormal">ye</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4653em;"></span><span class="mord">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4653em;"></span><span class="mord">∗</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span></span></span></span>3,283/year per database</li>
</ul>
<h3 id="size-comparison"><a class="header" href="#size-comparison">Size Comparison</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Traditional</th><th>CASG</th><th>Savings</th></tr></thead><tbody>
<tr><td>Check for updates</td><td>Download full DB (100GB)</td><td>HEAD request (1KB)</td><td>99.999%</td></tr>
<tr><td>Manifest download</td><td>N/A</td><td>100KB</td><td>-</td></tr>
<tr><td>Typical update (1% change)</td><td>100GB</td><td>1GB + 100KB</td><td>99%</td></tr>
<tr><td>Taxonomic subset</td><td>Full DB</td><td>Only relevant chunks</td><td>80-95%</td></tr>
</tbody></table>
</div>
<h3 id="progressive-download-strategy"><a class="header" href="#progressive-download-strategy">Progressive Download Strategy</a></h3>
<pre class="mermaid">graph TD
    Start[Start Update Check]
    Head[HEAD Request&lt;br/&gt;1KB]

    Start --&gt; Head
    Head --&gt; Changed{ETag&lt;br/&gt;Changed?}

    Changed --&gt;|No| Done[No Updates]
    Changed --&gt;|Yes| Manifest[Download Manifest&lt;br/&gt;100KB]

    Manifest --&gt; Diff[Compute Diff]
    Diff --&gt; Priority{Priority&lt;br/&gt;Chunks?}

    Priority --&gt;|High| DownloadHigh[Download Critical&lt;br/&gt;~500MB]
    Priority --&gt;|Low| Queue[Queue for Later&lt;br/&gt;~2GB]

    DownloadHigh --&gt; Verify[Verify Integrity]
    Queue --&gt; Background[Background Download]

    style Start stroke:#1976d2,stroke-width:2px
    style Head stroke:#00796b,stroke-width:2px
    style Changed stroke:#f57c00,stroke-width:2px
    style Done stroke:#757575,stroke-width:2px
    style Manifest stroke:#388e3c,stroke-width:2px
    style Diff stroke:#00796b,stroke-width:2px
    style Priority stroke:#f57c00,stroke-width:2px
    style DownloadHigh stroke:#d32f2f,stroke-width:2px
    style Queue stroke:#f57c00,stroke-width:2px,stroke-dasharray: 5 5
    style Verify stroke:#388e3c,stroke-width:2px
    style Background stroke:#757575,stroke-width:2px,stroke-dasharray: 5 5
</pre>
<h2 id="compression-every-byte-counts"><a class="header" href="#compression-every-byte-counts">Compression: Every Byte Counts</a></h2>
<p>While manifests are already small, compression reduces them further. This matters when serving millions of manifest checks daily or when every kilobyte counts in bandwidth-constrained environments.</p>
<h3 id="compression-strategy"><a class="header" href="#compression-strategy">Compression Strategy</a></h3>
<p>Manifests compress exceptionally well because:</p>
<ol>
<li><strong>Repetitive Structure</strong>: JSON has repeated keys</li>
<li><strong>Hash Patterns</strong>: SHA256 hashes have predictable entropy</li>
<li><strong>Taxonomic IDs</strong>: Often sequential or clustered</li>
</ol>
<p>Manifests support multiple compression formats:</p>
<div class="table-wrapper"><table><thead><tr><th>Format</th><th>Extension</th><th>Typical Size</th><th>Use Case</th></tr></thead><tbody>
<tr><td>Raw JSON</td><td><code>.json</code></td><td>200KB</td><td>Development</td></tr>
<tr><td>Gzip</td><td><code>.json.gz</code></td><td>50KB</td><td>Standard distribution</td></tr>
<tr><td>Brotli</td><td><code>.json.br</code></td><td>35KB</td><td>CDN optimization</td></tr>
<tr><td>Zstandard</td><td><code>.json.zst</code></td><td>40KB</td><td>Fast decompression</td></tr>
</tbody></table>
</div>
<h2 id="security-trust-through-verification"><a class="header" href="#security-trust-through-verification">Security: Trust Through Verification</a></h2>
<p>In scientific computing, trust is earned through verification. CASG manifests include multiple layers of cryptographic proof, ensuring that the data you download is exactly what was published.</p>
<h3 id="defense-in-depth"><a class="header" href="#defense-in-depth">Defense in Depth</a></h3>
<p>CASG employs multiple security layers:</p>
<ol>
<li><strong>Content Addressing</strong>: Chunks are identified by their hash</li>
<li><strong>Merkle Proofs</strong>: Prove chunks belong to the database</li>
<li><strong>Manifest Integrity</strong>: ETags and internal consistency checks</li>
<li><strong>Optional Signatures</strong>: Cryptographic signatures from publishers</li>
</ol>
<h3 id="integrity-verification"><a class="header" href="#integrity-verification">Integrity Verification</a></h3>
<p>Every manifest includes cross-validation:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn verify_manifest(manifest: &amp;Manifest) -&gt; Result&lt;bool&gt; {
    // 1. Verify internal consistency
    let computed_etag = compute_etag(&amp;manifest);
    if computed_etag != manifest.etag {
        return Ok(false);
    }

    // 2. Verify Merkle roots
    let chunks_root = compute_merkle_root(&amp;manifest.chunk_index);
    if chunks_root != manifest.sequence_root {
        return Ok(false);
    }

    // 3. Optional: Verify signature
    if let Some(sig) = &amp;manifest.signature {
        verify_signature(manifest, sig)?;
    }

    Ok(true)
}
<span class="boring">}</span></code></pre></pre>
<h3 id="trust-chain"><a class="header" href="#trust-chain">Trust Chain</a></h3>
<pre class="mermaid">graph TD
    Root[Root CA]
    Int[Intermediate Cert]
    Manifest[Manifest Signature]
    Chunks[Chunk Hashes]

    Root --&gt; Int
    Int --&gt; Manifest
    Manifest --&gt; Chunks

    Chunks --&gt; C1[Chunk 1&lt;br/&gt;SHA256: abc...]
    Chunks --&gt; C2[Chunk 2&lt;br/&gt;SHA256: def...]
    Chunks --&gt; C3[Chunk 3&lt;br/&gt;SHA256: ghi...]

    style Root stroke:#7b1fa2,stroke-width:3px
    style Int stroke:#512da8,stroke-width:2px
    style Manifest stroke:#388e3c,stroke-width:2px
    style Chunks stroke:#1976d2,stroke-width:2px
    style C1 stroke:#0288d1,stroke-width:2px
    style C2 stroke:#0288d1,stroke-width:2px
    style C3 stroke:#0288d1,stroke-width:2px
</pre>
<h2 id="performance-metrics-speed-at-scale"><a class="header" href="#performance-metrics-speed-at-scale">Performance Metrics: Speed at Scale</a></h2>
<p>Manifest operations are designed to be fast enough for interactive use while scaling to databases with millions of chunks.</p>
<h3 id="optimization-techniques"><a class="header" href="#optimization-techniques">Optimization Techniques</a></h3>
<ol>
<li><strong>Streaming Parsers</strong>: Begin processing before download completes</li>
<li><strong>Lazy Evaluation</strong>: Only parse what’s needed</li>
<li><strong>Hash Tables</strong>: O(1) lookup for chunk comparison</li>
<li><strong>Parallel Processing</strong>: Diff computation uses all CPU cores</li>
</ol>
<p>Typical manifest operations:</p>
<div class="table-wrapper"><table><thead><tr><th>Operation</th><th>Time</th><th>Memory</th></tr></thead><tbody>
<tr><td>Parse manifest (200KB)</td><td>&lt;10ms</td><td>2MB</td></tr>
<tr><td>Compute diff (10K chunks)</td><td>&lt;50ms</td><td>20MB</td></tr>
<tr><td>Verify integrity</td><td>&lt;100ms</td><td>5MB</td></tr>
<tr><td>Generate subset manifest</td><td>&lt;20ms</td><td>10MB</td></tr>
</tbody></table>
</div>
<h2 id="best-practices-lessons-from-production"><a class="header" href="#best-practices-lessons-from-production">Best Practices: Lessons from Production</a></h2>
<h3 id="1-cache-manifests-locally"><a class="header" href="#1-cache-manifests-locally">1. Cache Manifests Locally</a></h3>
<p>Always cache manifests with their ETags:</p>
<pre><code class="language-bash">${TALARIA_HOME}/cache/manifests/
├── uniprot-swissprot-20240315.json
├── uniprot-swissprot-20240315.etag
└── ncbi-nr-20240310.json
</code></pre>
<p>This enables instant local operations and offline work.</p>
<h3 id="2-check-updates-frequently"><a class="header" href="#2-check-updates-frequently">2. Check Updates Frequently</a></h3>
<p>HEAD requests are essentially free:</p>
<ul>
<li>1KB request</li>
<li>&lt;100ms response</li>
<li>No computational cost</li>
<li>Can check hourly without impact</li>
</ul>
<h3 id="3-batch-chunk-downloads"><a class="header" href="#3-batch-chunk-downloads">3. Batch Chunk Downloads</a></h3>
<p>Download multiple chunks in parallel:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let chunks_to_download = vec![hash1, hash2, hash3];
let downloads = chunks_to_download
    .par_iter()
    .map(|hash| download_chunk(hash))
    .collect();
<span class="boring">}</span></code></pre></pre>
<p>10-20 parallel downloads optimal for most networks.</p>
<h3 id="4-verify-manifest-integrity"><a class="header" href="#4-verify-manifest-integrity">4. Verify Manifest Integrity</a></h3>
<p>Always verify before trusting:</p>
<ol>
<li>Check ETag matches content</li>
<li>Verify Merkle roots</li>
<li>Validate chunk hashes during download</li>
<li>Optional: Verify publisher signature</li>
</ol>
<h3 id="5-keep-manifest-history"><a class="header" href="#5-keep-manifest-history">5. Keep Manifest History</a></h3>
<p>Maintain a git-like history:</p>
<pre><code>manifests/
├── current -&gt; 20240315_143022
├── 20240315_143022/
├── 20240215_120000/
└── 20240115_090000/
</code></pre>
<p>Enables rollback and historical analysis.</p>
<h3 id="6-implement-progressive-downloads"><a class="header" href="#6-implement-progressive-downloads">6. Implement Progressive Downloads</a></h3>
<p>Prioritize important chunks:</p>
<ol>
<li>Download manifest</li>
<li>Identify model organism chunks (high priority)</li>
<li>Download those immediately</li>
<li>Queue others for background download</li>
<li>Users can work while rest downloads</li>
</ol>
<h3 id="7-monitor-manifest-metrics"><a class="header" href="#7-monitor-manifest-metrics">7. Monitor Manifest Metrics</a></h3>
<p>Track key indicators:</p>
<ul>
<li>Update frequency (how often do manifests change?)</li>
<li>Chunk churn (what percentage changes per update?)</li>
<li>Download patterns (which chunks are hot?)</li>
<li>Compression ratios achieved</li>
</ul>
<p>These metrics inform optimization strategies.</p>
<h2 id="see-also"><a class="header" href="#see-also">See Also</a></h2>
<ul>
<li><a href="chunking.html">Chunking Algorithms</a></li>
<li><a href="merkle.html">Merkle DAG Structure</a></li>
<li><a href="../api/manifest.html">API Reference</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../casg/architecture.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../casg/chunking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../casg/architecture.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../casg/chunking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
