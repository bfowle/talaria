<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Common Workflows - Talaria Documentation</title>


        <!-- Custom HTML head -->
        <!-- MathJax Configuration -->
        <script>
        window.MathJax = {
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true
          },
          TeX: {
            equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"]
          }
        };
        </script>
        <meta name="description" content="Intelligent FASTA reduction for aligner index optimization">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "ayu";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Talaria Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/bfowle/talaria" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/bfowle/talaria/edit/main/docs/src/herald/workflows.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="herald-workflows-and-operations"><a class="header" href="#herald-workflows-and-operations">HERALD Workflows and Operations</a></h1>
<p>This document provides detailed, step-by-step explanations of how HERALD (Sequence Query Optimization with Indexed Architecture) operates in various scenarios, from initial database downloads to updates and synchronization.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ol>
<li><a href="#1-initial-database-download">Initial Database Download</a></li>
<li><a href="#2-checking-for-updates-dry-run">Checking for Updates (Dry-Run)</a></li>
<li><a href="#3-performing-database-updates">Performing Database Updates</a></li>
<li><a href="#4-taxonomy-synchronization">Taxonomy Synchronization</a></li>
<li><a href="#5-reduce-operation-with-herald">Reduce Operation with HERALD</a></li>
<li><a href="#6-should-taxonomy-be-checked-during-updates">Taxonomy Sync During Updates</a></li>
</ol>
<hr />
<h2 id="1-initial-database-download"><a class="header" href="#1-initial-database-download">1. Initial Database Download</a></h2>
<h3 id="what-happens-the-first-time"><a class="header" href="#what-happens-the-first-time">What Happens the FIRST Time</a></h3>
<p>When you download a database for the first time, HERALD performs a complete conversion from traditional FASTA format to its content-addressed storage system.</p>
<h4 id="command-example"><a class="header" href="#command-example">Command Example</a></h4>
<pre><code class="language-bash">talaria database download uniprot/swissprot
</code></pre>
<h4 id="step-by-step-process"><a class="header" href="#step-by-step-process">Step-by-Step Process</a></h4>
<pre class="mermaid">sequenceDiagram
    participant User
    participant CLI as Talaria CLI
    participant Download as Download Service
    participant HERALD as HERALD Storage
    participant FS as File System

    User-&gt;&gt;CLI: talaria database download uniprot/swissprot
    CLI-&gt;&gt;Download: GET /uniprot/swissprot.fasta.gz
    Download--&gt;&gt;CLI: Stream FASTA data (204 MB)
    CLI-&gt;&gt;CLI: Parse sequences
    CLI-&gt;&gt;FS: Load taxonomy mappings
    FS--&gt;&gt;CLI: Taxonomy data
    CLI-&gt;&gt;CLI: Create taxonomic chunks

    loop For each chunk
        CLI-&gt;&gt;HERALD: Store chunk with SHA256
        HERALD--&gt;&gt;CLI: Chunk stored
    end

    CLI-&gt;&gt;HERALD: Generate manifest
    CLI-&gt;&gt;FS: Create version directory
    CLI-&gt;&gt;FS: Save manifest &amp; metadata
    CLI-&gt;&gt;FS: Update current symlink
    CLI--&gt;&gt;User: ✓ Database downloaded (847 chunks)
</pre>
<h4 id="detailed-operations"><a class="header" href="#detailed-operations">Detailed Operations</a></h4>
<ol>
<li>
<p><strong>Download Phase</strong> (~5-10 minutes for SwissProt)</p>
<pre><code>Downloading UniProt/SwissProt...
[============&gt;] 204 MB / 204 MB
</code></pre>
</li>
<li>
<p><strong>Chunking Phase</strong> (1-2 minutes)</p>
<pre><code>Reading sequences from FASTA file...
Analyzing database structure...
  Total sequences: 565,928
  Unique taxa: 14,263
  High-volume taxa: 127
Creating taxonomy-aware chunks...
Created 847 chunks
</code></pre>
</li>
<li>
<p><strong>Storage Phase</strong> (30-60 seconds)</p>
<pre><code>Storing chunks in HERALD repository
[============&gt;] 847/847 chunks
All chunks stored
</code></pre>
</li>
<li>
<p><strong>Manifest Creation</strong> (instant)</p>
<pre><code>Creating and saving manifest...
Manifest saved to: ~/.talaria/databases/versions/uniprot/swissprot/2024-03-15_123456/manifest.tal
Version: 2024-03-15_123456
</code></pre>
</li>
</ol>
<h4 id="file-structure-after-initial-download"><a class="header" href="#file-structure-after-initial-download">File Structure After Initial Download</a></h4>
<pre><code>~/.talaria/databases/
├── chunks/                              # Content-addressed storage
│   ├── 1a/
│   │   └── 1a2b3c4d5e6f...             # Chunk file (compressed)
│   ├── 2b/
│   │   └── 2b3c4d5e6f7a...
│   └── ... (847 chunk files)
├── versions/
│   └── uniprot/
│       └── swissprot/
│           ├── 2024-03-15_123456/      # Timestamped version
│           │   ├── manifest.tal         # Binary manifest (500KB)
│           │   └── version.tal          # Version metadata
│           └── current -&gt; 2024-03-15_123456  # Symlink
└── manifest.tal                         # Repository manifest
</code></pre>
<h4 id="key-points"><a class="header" href="#key-points">Key Points</a></h4>
<ul>
<li><strong>One-time conversion</strong>: The FASTA is downloaded and chunked only once</li>
<li><strong>Chunks are permanent</strong>: Once stored, chunks are immutable</li>
<li><strong>Manifest is tiny</strong>: 500KB manifest describes 204MB database</li>
<li><strong>Future updates are incremental</strong>: Only changed chunks download next time</li>
</ul>
<hr />
<h2 id="2-checking-for-updates-dry-run"><a class="header" href="#2-checking-for-updates-dry-run">2. Checking for Updates (Dry-Run)</a></h2>
<h3 id="command"><a class="header" href="#command">Command</a></h3>
<pre><code class="language-bash">talaria database update --dry-run uniprot/swissprot
</code></pre>
<h3 id="scenario-a-no-updates-available"><a class="header" href="#scenario-a-no-updates-available">Scenario A: No Updates Available</a></h3>
<h4 id="what-happens"><a class="header" href="#what-happens">What Happens</a></h4>
<pre class="mermaid">sequenceDiagram
    participant CLI as Talaria CLI
    participant Local as Local Storage
    participant Server as Manifest Server

    CLI-&gt;&gt;Local: Load local manifest
    Local--&gt;&gt;CLI: manifest.tal (SHA: abc123...)
    CLI-&gt;&gt;Server: HEAD /manifest.tal&lt;br/&gt;If-None-Match: &quot;abc123&quot;
    Server--&gt;&gt;CLI: 304 Not Modified
    CLI--&gt;&gt;CLI: ✓ Database is up to date
</pre>
<h4 id="output"><a class="header" href="#output">Output</a></h4>
<pre><code>► Checking for updates...
✓ Database is up to date
  Current version: 2024-03-15
  No changes detected
</code></pre>
<h4 id="behind-the-scenes"><a class="header" href="#behind-the-scenes">Behind the Scenes</a></h4>
<ol>
<li><strong>Manifest download</strong>: 500KB, &lt;2 seconds</li>
<li><strong>Comparison</strong>: Binary hash comparison, instant</li>
<li><strong>Result</strong>: No action needed</li>
</ol>
<h3 id="scenario-b-updates-available"><a class="header" href="#scenario-b-updates-available">Scenario B: Updates Available</a></h3>
<h4 id="what-happens-1"><a class="header" href="#what-happens-1">What Happens</a></h4>
<pre class="mermaid">sequenceDiagram
    participant CLI as Talaria CLI
    participant Local as Local Storage
    participant Server as Manifest Server

    CLI-&gt;&gt;Local: Load local manifest
    Local--&gt;&gt;CLI: manifest.tal (SHA: abc123...)
    CLI-&gt;&gt;Server: HEAD /manifest.tal&lt;br/&gt;If-None-Match: &quot;abc123&quot;
    Server--&gt;&gt;CLI: 200 OK, ETag: &quot;def456&quot;
    CLI-&gt;&gt;Server: GET /manifest.tal
    Server--&gt;&gt;CLI: New manifest data
    CLI-&gt;&gt;CLI: Compute diff
    Note over CLI: New: 42 chunks&lt;br/&gt;Modified: 18 chunks&lt;br/&gt;Removed: 3 chunks
    CLI--&gt;&gt;CLI: Report changes summary
</pre>
<h4 id="output-1"><a class="header" href="#output-1">Output</a></h4>
<pre><code>► Checking for updates...
✓ Updates available
  Current version: 2024-03-15
  Latest version: 2024-04-01

  Changes summary:
  - New chunks: 42 (12.6 MB)
  - Modified chunks: 18 (5.4 MB)
  - Removed chunks: 3
  - Total download: 18 MB (8.8% of database)

  Taxonomy changes:
  - 127 sequences reclassified
  - 15 new taxa added

  Run without --dry-run to apply updates
</code></pre>
<h4 id="diff-analysis"><a class="header" href="#diff-analysis">Diff Analysis</a></h4>
<p>The manifest diff tells us exactly what changed:</p>
<pre><code class="language-json">{
  "new_chunks": ["3c4d5e6f...", "4d5e6f7a..."],
  "modified_chunks": ["5e6f7a8b..."],
  "removed_chunks": ["6f7a8b9c..."],
  "taxonomy_changes": {
    "reclassifications": 127,
    "new_taxa": 15
  }
}
</code></pre>
<hr />
<h2 id="3-performing-database-updates"><a class="header" href="#3-performing-database-updates">3. Performing Database Updates</a></h2>
<h3 id="command-1"><a class="header" href="#command-1">Command</a></h3>
<pre><code class="language-bash">talaria database update uniprot/swissprot
</code></pre>
<h3 id="what-happens-during-update"><a class="header" href="#what-happens-during-update">What Happens During Update</a></h3>
<pre class="mermaid">sequenceDiagram
    participant User
    participant CLI as Talaria CLI
    participant Server as Chunk Server
    participant HERALD as HERALD Storage
    participant FS as File System

    User-&gt;&gt;CLI: talaria database update
    CLI-&gt;&gt;CLI: Check for updates
    CLI-&gt;&gt;Server: GET /manifest.tal
    Server--&gt;&gt;CLI: New manifest
    CLI-&gt;&gt;CLI: Compute diff

    alt Changes detected
        CLI-&gt;&gt;User: Updates available (42 new chunks)

        loop For each new chunk
            CLI-&gt;&gt;Server: GET /chunks/[hash]
            Server--&gt;&gt;CLI: Chunk data
            CLI-&gt;&gt;CLI: Verify SHA256
            CLI-&gt;&gt;HERALD: Store chunk
        end

        CLI-&gt;&gt;HERALD: Update manifest
        CLI-&gt;&gt;FS: Create version 2024-04-01_094523
        CLI-&gt;&gt;FS: Update current symlink
        CLI-&gt;&gt;HERALD: Clean removed chunks (3)
        CLI--&gt;&gt;User: ✓ Update complete
    else No changes
        CLI--&gt;&gt;User: Database is up to date
    end
</pre>
<h3 id="detailed-process"><a class="header" href="#detailed-process">Detailed Process</a></h3>
<ol>
<li>
<p><strong>Manifest Check</strong> (2 seconds)</p>
<pre><code>Checking for updates...
Updates available, downloading manifest...
</code></pre>
</li>
<li>
<p><strong>Incremental Download</strong> (30-60 seconds for typical update)</p>
<pre><code>Need to download 42 new chunks, remove 3 old chunks
Downloading new chunks...
[============&gt;] 42/42 chunks
Downloaded 42 chunks, 18.00 MB
</code></pre>
</li>
<li>
<p><strong>Storage Update</strong> (instant)</p>
<pre><code>Updating local manifest...
Cleaning up removed chunks...
</code></pre>
</li>
<li>
<p><strong>Version Management</strong></p>
<pre><code>Creating version: 2024-04-01_094523
Updating symlinks...
</code></pre>
</li>
</ol>
<h3 id="file-structure-after-update"><a class="header" href="#file-structure-after-update">File Structure After Update</a></h3>
<pre><code>~/.talaria/databases/
├── chunks/
│   ├── ... (existing chunks)
│   ├── 7a/
│   │   └── 7a8b9c0d1e2f...    # New chunk from update
│   └── 8b/
│       └── 8b9c0d1e2f3a...    # Another new chunk
├── versions/
│   └── uniprot/
│       └── swissprot/
│           ├── 2024-03-15_123456/      # Previous version
│           ├── 2024-04-01_094523/      # New version
│           │   ├── manifest.tal
│           │   └── version.tal
│           └── current -&gt; 2024-04-01_094523  # Updated symlink
</code></pre>
<h3 id="key-points-1"><a class="header" href="#key-points-1">Key Points</a></h3>
<ul>
<li><strong>Only downloads changes</strong>: 18MB instead of 204MB full database</li>
<li><strong>Keeps version history</strong>: Old versions remain accessible</li>
<li><strong>Atomic updates</strong>: Symlink switch makes update instant</li>
<li><strong>Deduplication</strong>: Unchanged chunks are shared between versions</li>
</ul>
<hr />
<h2 id="4-taxonomy-synchronization"><a class="header" href="#4-taxonomy-synchronization">4. Taxonomy Synchronization</a></h2>
<h3 id="command-2"><a class="header" href="#command-2">Command</a></h3>
<pre><code class="language-bash">talaria database update-taxonomy
</code></pre>
<h3 id="what-happens-2"><a class="header" href="#what-happens-2">What Happens</a></h3>
<pre class="mermaid">sequenceDiagram
    participant User
    participant CLI as Talaria CLI
    participant NCBI
    participant Parser as Taxonomy Parser
    participant HERALD as HERALD Storage

    User-&gt;&gt;CLI: talaria database update-taxonomy
    CLI-&gt;&gt;NCBI: HEAD /pub/taxonomy/taxdump.tar.gz
    NCBI--&gt;&gt;CLI: Last-Modified: 2024-04-15

    alt New version available
        CLI-&gt;&gt;NCBI: GET /pub/taxonomy/taxdump.tar.gz
        NCBI--&gt;&gt;CLI: Stream taxonomy data (58 MB)
        CLI-&gt;&gt;Parser: Extract &amp; parse files
        Parser--&gt;&gt;CLI: nodes.dmp, names.dmp, ...

        CLI-&gt;&gt;Parser: Build taxonomy tree
        Note over Parser: 2,392,776 taxa&lt;br/&gt;3,789,532 names

        CLI-&gt;&gt;CLI: Detect reclassifications
        Note over CLI: 1,247 reclassifications&lt;br/&gt;8,923 new taxa&lt;br/&gt;127 deprecated

        loop For affected chunks
            CLI-&gt;&gt;HERALD: Update chunk metadata
            HERALD--&gt;&gt;CLI: Metadata updated
        end

        CLI-&gt;&gt;HERALD: Create taxonomy manifest
        CLI-&gt;&gt;HERALD: Update bi-temporal coordinates
        CLI--&gt;&gt;User: ✓ Taxonomy updated to 2024-04-15
    else Already current
        CLI--&gt;&gt;User: Taxonomy is up to date
    end
</pre>
<h3 id="process-details"><a class="header" href="#process-details">Process Details</a></h3>
<ol>
<li>
<p><strong>Check for Updates</strong> (instant)</p>
<pre><code>► Checking for taxonomy updates...
New taxonomy version available: 2024-04-15
</code></pre>
</li>
<li>
<p><strong>Download &amp; Extract</strong> (1-2 minutes)</p>
<pre><code>Downloading NCBI taxdump...
[============&gt;] 58 MB / 58 MB
Extracting taxonomy files...
</code></pre>
</li>
<li>
<p><strong>Parse &amp; Build Tree</strong> (30 seconds)</p>
<pre><code>Parsing nodes.dmp... 2,392,776 taxa
Parsing names.dmp... 3,789,532 names
Building taxonomy tree...
</code></pre>
</li>
<li>
<p><strong>Detect Changes</strong> (10-20 seconds)</p>
<pre><code>Analyzing taxonomic changes...
- Reclassifications: 1,247
- New taxa: 8,923
- Deprecated taxa: 127
- Merged taxa: 43
</code></pre>
</li>
<li>
<p><strong>Update Sequences</strong> (1-2 minutes)</p>
<pre><code>Updating sequence-taxonomy mappings...
Processing affected chunks...
[============&gt;] 127/127 chunks updated
</code></pre>
</li>
</ol>
<h3 id="impact-on-herald-structure"><a class="header" href="#impact-on-herald-structure">Impact on HERALD Structure</a></h3>
<h4 id="bi-temporal-coordinate-update"><a class="header" href="#bi-temporal-coordinate-update">Bi-Temporal Coordinate Update</a></h4>
<pre><code>Before: (seq_time: 2024-04-01, tax_time: 2024-03-01)
After:  (seq_time: 2024-04-01, tax_time: 2024-04-15)
</code></pre>
<h4 id="chunk-metadata-updates"><a class="header" href="#chunk-metadata-updates">Chunk Metadata Updates</a></h4>
<p>Chunks containing reclassified sequences get updated metadata:</p>
<pre><code class="language-json">{
  "chunk_hash": "7a8b9c0d...",
  "taxonomy_version": "2024-04-15",
  "taxon_ids": [562, 511145],  // Updated taxonomy
  "discrepancies": [
    {
      "sequence_id": "P12345",
      "old_taxon": 1578,        // Old Lactobacillus
      "new_taxon": 2742843,      // New genus
      "type": "Reclassified"
    }
  ]
}
</code></pre>
<hr />
<h2 id="5-reduce-operation-with-herald"><a class="header" href="#5-reduce-operation-with-herald">5. Reduce Operation with HERALD</a></h2>
<h3 id="how-reduce-uses-herald-data"><a class="header" href="#how-reduce-uses-herald-data">How Reduce Uses HERALD Data</a></h3>
<p>When you run <code>reduce</code> after downloading a HERALD database, it can leverage the existing chunk structure for efficiency.</p>
<h3 id="command-3"><a class="header" href="#command-3">Command</a></h3>
<pre><code class="language-bash">talaria reduce -i ecoli_proteins.fasta -o reduced.fasta --use-herald-db uniprot/swissprot
</code></pre>
<h3 id="process-flow"><a class="header" href="#process-flow">Process Flow</a></h3>
<pre class="mermaid">sequenceDiagram
    participant User
    participant Reducer as Talaria Reducer
    participant HERALD as HERALD Database
    participant Lambda as LAMBDA Aligner

    User-&gt;&gt;Reducer: talaria reduce -i input.fasta&lt;br/&gt;--use-herald-db uniprot/swissprot
    Reducer-&gt;&gt;HERALD: Load database manifest
    HERALD--&gt;&gt;Reducer: 862 chunks available
    Reducer-&gt;&gt;Reducer: Parse input sequences

    Reducer-&gt;&gt;HERALD: Extract taxonomy-relevant chunks
    HERALD--&gt;&gt;Reducer: Chunk data (references)

    Reducer-&gt;&gt;Lambda: Build reference index
    Lambda--&gt;&gt;Reducer: Index ready

    loop For each query sequence
        Reducer-&gt;&gt;Lambda: Find best references
        Lambda--&gt;&gt;Reducer: Top matches
        Reducer-&gt;&gt;Reducer: Compute delta encoding
    end

    Reducer-&gt;&gt;Reducer: Generate reduced FASTA
    Reducer--&gt;&gt;User: ✓ Reduced output.fasta&lt;br/&gt;(90% size reduction)
</pre>
<h3 id="after-initial-download-1"><a class="header" href="#after-initial-download-1">After Initial Download (#1)</a></h3>
<p>The reduce operation can:</p>
<ol>
<li><strong>Use HERALD chunks as reference candidates</strong> - No need to build indices from scratch</li>
<li><strong>Leverage taxonomy information</strong> - Better reference selection for taxonomically similar sequences</li>
<li><strong>Access pre-computed similarities</strong> - Chunks already group similar sequences</li>
</ol>
<h3 id="after-database-update-3"><a class="header" href="#after-database-update-3">After Database Update (#3)</a></h3>
<p>When the database is updated, reduce automatically uses the new data:</p>
<pre><code class="language-bash"># Before update (using 2024-03-15 version)
talaria reduce -i query.fasta -o reduced_old.fasta
# References selected from 847 chunks, version 2024-03-15

# After update (using 2024-04-01 version)
talaria reduce -i query.fasta -o reduced_new.fasta
# References selected from 862 chunks, version 2024-04-01
# Includes 42 new chunks with potentially better references
</code></pre>
<h4 id="key-benefits"><a class="header" href="#key-benefits">Key Benefits</a></h4>
<ul>
<li><strong>Always current</strong>: Reduce uses the <code>current</code> symlink to latest version</li>
<li><strong>Incremental improvement</strong>: New chunks may contain better reference sequences</li>
<li><strong>Taxonomy-aware</strong>: Updated taxonomy improves reference selection accuracy</li>
</ul>
<hr />
<h2 id="6-should-taxonomy-be-checked-during-updates"><a class="header" href="#6-should-taxonomy-be-checked-during-updates">6. Should Taxonomy Be Checked During Updates?</a></h2>
<h3 id="current-behavior"><a class="header" href="#current-behavior">Current Behavior</a></h3>
<p>When running <code>talaria database update</code>, taxonomy is <strong>NOT automatically checked</strong> unless:</p>
<ol>
<li>You explicitly include <code>--include-taxonomy</code> flag</li>
<li>You’re updating a taxonomy database directly</li>
<li>You run update without specifying a database (checks all)</li>
</ol>
<h3 id="recommended-workflow"><a class="header" href="#recommended-workflow">Recommended Workflow</a></h3>
<h4 id="option-a-separate-updates-current-default"><a class="header" href="#option-a-separate-updates-current-default">Option A: Separate Updates (Current Default)</a></h4>
<pre><code class="language-bash"># Update sequences only
talaria database update uniprot/swissprot

# Update taxonomy separately when needed
talaria database update-taxonomy
</code></pre>
<p><strong>Pros:</strong></p>
<ul>
<li>Faster sequence updates (no taxonomy download)</li>
<li>Can update sequences without waiting for taxonomy</li>
<li>More control over when taxonomy changes apply</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Sequences and taxonomy can become out of sync</li>
<li>May miss important reclassifications</li>
</ul>
<h4 id="option-b-combined-updates-with-flag"><a class="header" href="#option-b-combined-updates-with-flag">Option B: Combined Updates (With Flag)</a></h4>
<pre><code class="language-bash"># Update sequences AND check taxonomy
talaria database update uniprot/swissprot --include-taxonomy
</code></pre>
<p><strong>Pros:</strong></p>
<ul>
<li>Ensures consistency between sequences and taxonomy</li>
<li>Automatic detection of reclassifications</li>
<li>Single command for complete update</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Slower (downloads taxonomy even if unchanged)</li>
<li>May introduce unexpected taxonomic changes</li>
</ul>
<h3 id="recommendation"><a class="header" href="#recommendation">Recommendation</a></h3>
<p><strong>For production pipelines:</strong> Use separate updates to maintain control</p>
<pre><code class="language-bash"># Weekly sequence updates
talaria database update uniprot/swissprot

# Monthly taxonomy sync
talaria database update-taxonomy
talaria database check uniprot/swissprot  # Check for discrepancies
</code></pre>
<p><strong>For research use:</strong> Use combined updates for consistency</p>
<pre><code class="language-bash">talaria database update uniprot/swissprot --include-taxonomy
</code></pre>
<h3 id="future-enhancement-proposal"><a class="header" href="#future-enhancement-proposal">Future Enhancement Proposal</a></h3>
<p>The system could automatically check if taxonomy is significantly out of date:</p>
<pre><code>► Updating UniProt/SwissProt...
⚠ Taxonomy is 89 days old (last updated: 2024-01-15)
  Recommendation: Run 'talaria database update-taxonomy'
  Or use --include-taxonomy to update both
</code></pre>
<hr />
<h2 id="summary-of-key-concepts"><a class="header" href="#summary-of-key-concepts">Summary of Key Concepts</a></h2>
<h3 id="manifest-chunk-relationship"><a class="header" href="#manifest-chunk-relationship">Manifest-Chunk Relationship</a></h3>
<ul>
<li><strong>Manifest</strong>: Compact index (500KB) listing all chunks with hashes</li>
<li><strong>Chunks</strong>: Actual sequence data (1-50MB each), content-addressed</li>
<li><strong>Updates</strong>: Compare manifests, download only new/changed chunks</li>
</ul>
<h3 id="version-management"><a class="header" href="#version-management">Version Management</a></h3>
<ul>
<li>Every update creates a new timestamped version directory</li>
<li><code>current</code> symlink points to active version</li>
<li>Old versions remain accessible for reproducibility</li>
</ul>
<h3 id="bi-temporal-benefits"><a class="header" href="#bi-temporal-benefits">Bi-Temporal Benefits</a></h3>
<ul>
<li><strong>Sequence updates</strong>: Change sequence timeline</li>
<li><strong>Taxonomy updates</strong>: Change taxonomy timeline</li>
<li><strong>Independent updates</strong>: Can update sequences without taxonomy and vice versa</li>
<li><strong>Time-travel queries</strong>: Can query any combination of sequence/taxonomy time</li>
</ul>
<h3 id="storage-efficiency"><a class="header" href="#storage-efficiency">Storage Efficiency</a></h3>
<ul>
<li><strong>Initial download</strong>: One-time conversion cost</li>
<li><strong>Updates</strong>: Only changed chunks (typically 5-10% of database)</li>
<li><strong>Deduplication</strong>: Identical chunks stored once</li>
<li><strong>Compression</strong>: Each chunk is zstd-compressed</li>
</ul>
<h3 id="performance-expectations"><a class="header" href="#performance-expectations">Performance Expectations</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Operation</th><th>Time</th><th>Network</th><th>Storage</th></tr></thead><tbody>
<tr><td>Initial SwissProt download</td><td>5-10 min</td><td>204 MB</td><td>180 MB</td></tr>
<tr><td>Typical update</td><td>30-60 sec</td><td>10-20 MB</td><td>+5-10 MB</td></tr>
<tr><td>Taxonomy update</td><td>2-3 min</td><td>58 MB</td><td>45 MB</td></tr>
<tr><td>Dry-run check</td><td>2-5 sec</td><td>500 KB</td><td>0</td></tr>
<tr><td>Reduce with HERALD</td><td>(faster)</td><td>0</td><td>0</td></tr>
</tbody></table>
</div>
<p>This workflow documentation reflects the actual HERALD implementation and provides clear guidance on how the system operates in practice.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../herald/getting-started.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../herald/example-workflow.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../herald/getting-started.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../herald/example-workflow.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
